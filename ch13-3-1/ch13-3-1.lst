     1                                  ; Example from Chapter 13.3.1
     2                                  ; A program to print a set of messages to the console
     3                                  
     4                                  default rel
     5                                  
     6                                  ; ******************************
     7                                  
     8                                  section     .data
     9                                  
    10                                  SUCCESS     equ     0
    11                                  SYS_exit    equ     0x2000001
    12                                  
    13                                  STDOUT      equ     1
    14                                  SYS_write   equ     0x2000004
    15                                  
    16                                  LF          equ     10
    17                                  NULL        equ     0
    18                                  
    19 00000000 48656C6C6F2C20776F-     message1    db      "Hello, world!", LF, NULL
    19 00000009 726C64210A00       
    20 0000000F 596F20796F20796F21-     message2    db      "Yo yo yo!", LF, NULL
    20 00000018 0A00               
    21 0000001A 466F6F206261722062-     message3    db      "Foo bar baz", LF, NULL
    21 00000023 617A0A00           
    22                                  
    23                                  ; ******************************
    24                                  
    25                                  section     .text
    26                                  global _start
    27                                  _start:
    28                                  
    29 00000000 41BA00000000                mov     r10, 0
    30 00000006 488D3D(00000000)            lea     rdi, [message1]
    31 0000000D E80C000000                  call    printString
    32                                  
    33                                  exit:
    34                                  
    35 00000012 B801000002                  mov     rax, SYS_exit
    36 00000017 BF00000000                  mov     rdi, SUCCESS
    37 0000001C 0F05                        syscall
    38                                  
    39                                  ; -----
    40                                  ; Prints a string to the console
    41                                  ; Args:
    42                                  ;   * rdi - message (address)
    43                                  ; Syscall:
    44                                  ;   ssize_t
    45                                  ;   write(int fildes, const void *buf, size_t nbyte);
    46                                  ;         rdi         rsi              rdx
    47                                  
    48                                  global printString:
    49                                  printString:
    50                                  
    51 0000001E B804000002                  mov     rax, SYS_write
    52 00000023 BA00000000                  mov     rdx, 0                  ; 3rd arg
    53 00000028 4889FE                      mov     rsi, rdi                ; 2nd arg
    54 0000002B BF01000000                  mov     rdi, STDOUT             ; 1st arg
    55                                  
    56                                  getLength:
    57                                  
    58                                      ; Get the length of the string so we know how many bytes to read from the buffer
    59                                  
    60 00000030 4883FE00                    cmp     rsi, NULL
    61 00000034 7408                        je      doPrint
    62 00000036 48FFC6                      inc     rsi                     ; increase the pointer one byte
    63 00000039 48FFC2                      inc     rdx                     ; increase the size of nbytes
    64 0000003C EBF2                        jmp     getLength
    65                                  
    66                                  doPrint:
    67                                  
    68 0000003E 0F05                        syscall
    69 00000040 C3                          ret
